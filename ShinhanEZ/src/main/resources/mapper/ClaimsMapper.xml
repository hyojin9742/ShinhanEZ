<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shinhanez.admin.mapper.ClaimsMapper">

  <!-- 1) ResultMap : DB 컬럼 ↔ DTO 필드 매핑 -->
  <resultMap id="ClaimsResultMap" type="com.shinhanez.admin.domain.ClaimsDTO">
    <id property="claimId" column="CLAIM_ID"/>

    <result property="customerId" column="CUSTOMER_ID"/>
    <result property="insuredId" column="INSURED_ID"/>
    <result property="contractId" column="CONTRACT_ID"/>

    <result property="accidentDate" column="ACCIDENT_DATE"/>
    <result property="claimDate" column="CLAIM_DATE"/>

    <result property="claimAmount" column="CLAIM_AMOUNT"/>
    <result property="documentList" column="DOCUMENT_LIST"/>

    <result property="paidAt" column="PAID_AT"/>
    <result property="paidAmount" column="PAID_AMOUNT"/>

    <result property="status" column="STATUS"/>
    <result property="completedAt" column="COMPLETED_AT"/>

    <result property="adminId" column="ADMIN_ID"/>
    
    <result property="customerName" column="CUSTOMER_NAME"/>
	<result property="insuredName"  column="INSURED_NAME"/>
	<result property="adminName"    column="ADMIN_NAME"/>
  </resultMap>


  <!-- 2) 목록 조회 -->
<select id="getClaimList"
        parameterType="com.shinhanez.admin.domain.ClaimsCriteria"
        resultMap="ClaimsResultMap">

SELECT *
FROM (
  SELECT
    t.*,
    ROWNUM AS rn
  FROM (
    SELECT
      c.CLAIM_ID,
      c.STATUS,
      cust.NAME AS CUSTOMER_NAME,
      ins.NAME  AS INSURED_NAME,
      c.ACCIDENT_DATE,
      c.CLAIM_AMOUNT,
      c.CLAIM_DATE,
      adm.NAME  AS ADMIN_NAME
    FROM SHEZ_CLAIMS c
    LEFT JOIN SHEZ_CUSTOMERS cust ON cust.CUSTOMER_ID = c.CUSTOMER_ID
    LEFT JOIN SHEZ_CUSTOMERS ins  ON ins.CUSTOMER_ID  = c.INSURED_ID
    LEFT JOIN SHEZ_ADMINS adm     ON adm.ADMIN_ID     = c.ADMIN_ID

    <where>
      <if test="status != null and status != ''">
        AND c.STATUS = #{status}
      </if>

      <if test="fromDate != null">
        AND c.CLAIM_DATE &gt;= #{fromDate}
      </if>
      <if test="toDate != null">
        AND c.CLAIM_DATE &lt;= #{toDate}
      </if>

      <if test="keyword != null and keyword != ''">
        AND (
             TO_CHAR(c.CLAIM_ID) LIKE '%' || #{keyword} || '%'
          OR LOWER(cust.NAME)    LIKE '%' || LOWER(#{keyword}) || '%'
          OR LOWER(ins.NAME)     LIKE '%' || LOWER(#{keyword}) || '%'
        )
      </if>
    </where>

    ORDER BY
      CASE c.STATUS
        WHEN 'PENDING'   THEN 1
        WHEN 'REJECTED'  THEN 2
        WHEN 'COMPLETED' THEN 3
        ELSE 4
      END,
      c.CLAIM_ID DESC
  ) t
  WHERE ROWNUM &lt;= #{endRow}
)
WHERE rn &gt; #{startRow}

</select>




  <!-- 3) 단건 조회 -->
  <select id="getClaim" parameterType="long" resultMap="ClaimsResultMap">
    SELECT
      CLAIM_ID,
      CUSTOMER_ID,
      INSURED_ID,
      CONTRACT_ID,
      ACCIDENT_DATE,
      CLAIM_DATE,
      CLAIM_AMOUNT,
      DOCUMENT_LIST,
      PAID_AT,
      PAID_AMOUNT,
      STATUS,
      COMPLETED_AT,
      ADMIN_ID
    FROM SHEZ_CLAIMS
    WHERE CLAIM_ID = #{claimId}
  </select>


  <!-- 4) 등록 -->
	<insert id="insertClaim" parameterType="com.shinhanez.admin.domain.ClaimsDTO">
	
	  <selectKey keyProperty="claimId" resultType="long" order="BEFORE">
	    SELECT seq_claim_id.NEXTVAL FROM dual
	  </selectKey>
	
	  INSERT INTO SHEZ_CLAIMS (
	    CLAIM_ID,
	    CUSTOMER_ID,
	    INSURED_ID,
	    CONTRACT_ID,
	    ACCIDENT_DATE,
	    CLAIM_DATE,
	    CLAIM_AMOUNT,
	    DOCUMENT_LIST,
	    PAID_AT,
	    PAID_AMOUNT,
	    STATUS,
	    COMPLETED_AT,
	    ADMIN_ID
	  ) VALUES (
	    #{claimId},
	    #{customerId},
	    #{insuredId},
	    #{contractId},
	    #{accidentDate},
	    SYSDATE,
	    #{claimAmount},
	    #{documentList},
	    #{paidAt, jdbcType=DATE},
	    #{paidAmount, jdbcType=NUMERIC},
	    #{status},
	    #{completedAt, jdbcType=DATE},
	    #{adminId}
	  )
	
	</insert>


	<!-- 5-1) 청구수정 -->
	<update id="updateClaim" parameterType="com.shinhanez.admin.domain.ClaimsDTO">
	  UPDATE SHEZ_CLAIMS
	  <set>
	    <!-- 기본 정보 -->
	    <if test="customerId != null">CUSTOMER_ID = #{customerId},</if>
	    <if test="insuredId != null">INSURED_ID = #{insuredId},</if>
	    <if test="contractId != null">CONTRACT_ID = #{contractId},</if>
	    <if test="accidentDate != null">ACCIDENT_DATE = #{accidentDate},</if>
	    <if test="claimAmount != null">CLAIM_AMOUNT = #{claimAmount},</if>
	
	    <if test="documentList != null and documentList != ''">DOCUMENT_LIST = #{documentList},</if>
	
	    <!-- 결정/지급/완료 -->
	    <if test="status != null">STATUS = #{status},</if>
	    <if test="paidAt != null">PAID_AT = #{paidAt, jdbcType=DATE},</if>
	    <if test="paidAmount != null">PAID_AMOUNT = #{paidAmount, jdbcType=NUMERIC},</if>
	    <if test="status == 'COMPLETED' or status == 'REJECTED'">COMPLETED_AT = SYSDATE,</if>	
	    <if test="adminId != null">ADMIN_ID = #{adminId},</if>
	  </set>
	  WHERE CLAIM_ID = #{claimId}
	</update>

  	<!-- 6) 삭제 -->
	<delete id="deleteClaim" parameterType="map">
	  DELETE FROM SHEZ_CLAIMS c
	  WHERE c.CLAIM_ID = #{claimId}
	    AND EXISTS (
	      SELECT 1
	      FROM SHEZ_ADMINS a
	      WHERE a.ADMIN_ID = #{adminId}
	        AND a.ROLE = 'super'
	    )
	</delete>

  <!-- 7) 고객의 계약 리스트 조회 -->
	<select id="getListContractsByCustomerId" resultType="com.shinhanez.admin.domain.Contracts">
		<![CDATA[
		SELECT 
		    c.contract_id,
		    c.customer_id,
		    cu.name AS customer_name,
		    c.insured_id,
		    ins.name AS insured_name,
		    c.product_id,
		    p.productname AS product_name,
		    c.reg_date,
		    c.expired_date,
		    c.contract_status,
		    c.premium_amount,
		    c.payment_cycle,
		    c.admin_id,
		    ad.name AS admin_name
		FROM 
		    shez_contracts c
		    INNER JOIN shez_customers cu ON c.customer_id = cu.customer_id
		    INNER JOIN shez_customers ins ON c.insured_id = ins.customer_id
		    INNER JOIN shez_insurances p ON c.product_id = p.productno
		    INNER JOIN shez_admins ad ON c.admin_id = ad.admin_id
		WHERE 
		    c.customer_id = #{customerId}
		ORDER BY 
		    CASE c.contract_status
		        WHEN 'ACTIVE' THEN 1
		        WHEN 'EXPIRED' THEN 2
		        WHEN 'TERMINATED' THEN 3
		        ELSE 99
		    END,
		    c.reg_date DESC,
		    c.contract_id DESC
		]]>
	</select>

<!-- 전체 count -->
<select id="getClaimTotalCount" parameterType="com.shinhanez.admin.domain.ClaimsCriteria" resultType="int">
	SELECT COUNT(*)
	FROM SHEZ_CLAIMS c
	LEFT JOIN SHEZ_CUSTOMERS cust ON cust.CUSTOMER_ID = c.CUSTOMER_ID
	LEFT JOIN SHEZ_CUSTOMERS ins  ON ins.CUSTOMER_ID  = c.INSURED_ID
	LEFT JOIN SHEZ_ADMINS adm     ON adm.ADMIN_ID     = c.ADMIN_ID
	
	<where>
	  <if test="status != null and status != ''">
	    AND c.STATUS = #{status}
	  </if>
	
	  <if test="fromDate != null">
	    AND c.CLAIM_DATE &gt;= #{fromDate}
	  </if>
	  <if test="toDate != null">
	    AND c.CLAIM_DATE &lt;= #{toDate}
	  </if>
	
	  <if test="keyword != null and keyword != ''">
	    AND (
	         TO_CHAR(c.CLAIM_ID) LIKE '%' || #{keyword} || '%'
	      OR LOWER(cust.NAME)    LIKE '%' || LOWER(#{keyword}) || '%'
	      OR LOWER(ins.NAME)     LIKE '%' || LOWER(#{keyword}) || '%'
	    )
	  </if>
	</where>
</select>

</mapper>